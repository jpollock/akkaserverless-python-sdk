<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Publishing and subscribing to topics on a broker :: Akka Serverless Python SDK Documentation</title>
    <link rel="prev" href="entity-eventing.html">
    <link rel="next" href="views.html">
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../_/css/theme.1.1.0.min.css">
    <style>
        .article {
            font-family: acumin-pro,Helvetica,Arial,sans-serif;
        }
        .navbar {
            background-color: #0c323b4f;
        }
       .toolbar {
           background-color: white;
        }
        .site-id {
            left: 220px;
            font-size: 18px;
        }
        .header-logo {
            height: 80px;
        }
        .navbar .button {
            background-color: #ff931dff;
            color: white;
        }
    </style>

	<meta property="og:site_name" content="Lightbend Documentation" />
	<meta name="author" content="Lightbend Documentation">
	<link rel="shortcut icon" type="image/x-icon" href="../_/img/favicons/favicon.ico" />
	<meta itemprop="image" content="https://downloads.lightbend.com/website/social/lightbend-logo-orange-twitter.jpg">
	<meta name="twitter:image:src" content="https://downloads.lightbend.com/website/social/lightbend-logo-orange-twitter.jpg">
	<meta property="og:image" content="https://downloads.lightbend.com/website/social/lightbend-logo-orange-twitter.jpg" />
	<meta property="og:image:secure_url" content="https://downloads.lightbend.com/website/social/lightbend-logo-orange-twitter.jpg" />  </head>
  <body class="article production hide-versions ">
<header class="header" role="banner">
  <nav class="navbar">
      <div class="navbar-brand">
        <a class="navbar-item" href="#">
          <img class="header-logo lightbend-logo" src="../_/img/akka-serverless-full-color.svg">&nbsp;&nbsp;Python SDK Documentation
        </a>
      </div>
      <div id="topbar-nav" class="navbar-menu">
        <div class="navbar-end">
            <div class="navbar-item has-dropdown is-hoverable">
            <span class="navbar-link">Console</span>
            <div class="navbar-dropdown">
              <section>
                <a data-category="Link - Drop Down Link - Lightbend Docs" href="https://console.akkaserverless.com/p/login/" target="_blank">Register or Log in</a>
                <a data-category="Link - Drop Down Link - Lightbend Docs" href="https://status.akkaserverless.com/" target="_blank">Akka Serverless Status</a>
              </section>
            </div>
          </div>
          <div class="navbar-item has-dropdown is-hoverable">
            <span class="navbar-link">Resources</span>
            <div class="navbar-dropdown">
              <section>
                  <a data-category="Link - Drop Down Link - Lightbend Docs" href="https://discuss.lightbend.com/c/akka-serverless/40" target="
                  ">Discussion Forum</a>
                  <a data-category="Link - Drop Down Link - Lightbend Docs" href="https://www.lightbend.com/blog" target="_blank">Lightbend Blog</a>
                  <a data-category="Link - Drop Down Link - Lightbend Docs" href="https://academy.lightbend.com/" target="_blank">Lightbend Academy</a>
                  <a data-category="Link - Drop Down Link - Lightbend Docs" href="https://academy.lightbend.com/courses?search_query=FILTER_TYPE_FREE" target="_blank">Free Training</a>
              </section>
            </div>
          </div>
          <div class="navbar-item has-dropdown is-hoverable">
            <span class="navbar-link">Lightbend</span>
            <div class="navbar-dropdown">
              <section>
                  <a data-category="Link - Drop Down Link - Lightbend Docs" href="https://www.lightbend.com/about-lightbend" target="_blank">Who Is Lightbend?</a>
                  <a data-category="Link - Drop Down Link - Lightbend Docs" href="https://www.lightbend.com/customers" target="_blank">Who Uses Lightbend?</a>
                  <a data-category="Link - Drop Down Link - Lightbend Docs" href="https://www.lightbend.com/certified-reactive-architect" target="_blank">Certification</a>
                  <a data-category="Link - Drop Down Link - Lightbend Docs" href="https://www.lightbend.com/company/news" target="_blank">News & Press</a>
                  <a data-category="Link - Drop Down Link - Lightbend Docs" href="https://www.lightbend.com/contact" target="_blank">Get In Contact</a>
              </section>
            </div>
          </div>
        </div>
      </div>

  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">Developing with Python</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../developing/development-process-python.html">Process overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="getting-started.html">Getting Started</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="kickstart.html">Kickstart a Python module</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="proto.html">Writing gRPC descriptors</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="eventsourced.html">Implementing Event Sourced Entities</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="value-entity.html">Implementing Value Entities</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="actions.html">Implementing Actions</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="forwarding.html">Forwarding and effects</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="entity-eventing.html">Subscribing to a Journal</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="topic-eventing.html">Publishing and Subscribing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="views.html">Creating Views</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="serialization.html">Handling Serialization</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="run-locally.html">Run a service locally</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title"></span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html"></a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Developing with Python</a></li>
    <li><a href="topic-eventing.html">Publishing and Subscribing</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/jpollock/akkaserverless-python-sdk/edit/main/docs/src/modules/python/pages/topic-eventing.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="On This Page" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article id="page-content" class="doc">
<h1 class="page">Publishing and subscribing to topics on a broker</h1>
<fieldset class="supergroup-switch">
	




	


</fieldset><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Akka Serverless integrates with <a href="https://cloud.google.com/pubsub/docs/overview">Google Cloud Pub/Sub</a> to enable asynchronous messaging. Consumers of published messages are guaranteed to receive them at least once. This means that receivers must be able to handle duplicate messages. If you are new to the world of Pub/Sub, many online resources provide tips on handling duplicate messages.</p>
</div>
<div class="paragraph">
<p>This page describes how to subscribe to published events, but you also need to configure Google Cloud Pub/Sub access for your Akka Serverless project as explained in <a href="https://developer.lightbend.com/docs/akka-serverless/how-to/message-broker.html">How to configure a broker</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It is your responsibility to create the topics in Google Cloud Pub/Sub before configuring publishers or subscribers.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_subscribing_to_a_topics_messages"><a class="anchor" href="#_subscribing_to_a_topics_messages"></a>Subscribing to a topic&#8217;s messages</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To receive messages from a Pub/Sub topic, annotate a service method in the Protobuf service definition with the <code>(akkaserverless.method).eventing</code> annotation. Specify the topic name in the <code>in</code> section of the annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-protobuf hljs" data-lang="protobuf">syntax = "proto3";

package shopping.cart.actions;

import "akkaserverless/annotations.proto";
import "cart/shopping_cart_domain.proto";
import "google/protobuf/empty.proto";

service ShoppingCartAnalyticsService {
  // get ItemAdded from the topic
  rpc ProcessAdded(shopping.cart.domain.ItemAdded) returns (google.protobuf.Empty) {
    option (akkaserverless.method).eventing.in = { <i class="conum" data-value="1"></i><b>(1)</b>
      topic: "shopping-cart-events" <i class="conum" data-value="2"></i><b>(2)</b>
    };
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>annotate the Protobuf rpc method with <code>(akkaserverless.method).eventing</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>use <code>in</code> and <code>topic</code> to subscribe to a topic</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There is nothing specific required in the implementation of <code>ProcessAdded</code>. The implementation will in most cases be an Action and forward a converted message to a different component (eg. an Event Sourced Entity).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_receiving_json_messages"><a class="anchor" href="#_receiving_json_messages"></a>Receiving JSON messages</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Your Akka Serverless service may subscribe to topics that use messages in JSON format. The messages must have the <code>Content-Type</code> attribute stating <code>application/json</code>.</p>
</div>
<div class="paragraph">
<p>The Protobuf rpc method receiving these JSON messages must be set up to receive <code>Any</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-protobuf hljs" data-lang="protobuf">syntax = "proto3";

import "google/protobuf/empty.proto";
import "google/protobuf/any.proto";
import "akkaserverless/annotations.proto";

package shopping.cart.actions;

service ShoppingCartTopicService {
    rpc JsonFromTopic(google.protobuf.Any) returns (google.protobuf.Empty) {
        option (akkaserverless.method).eventing.in = {
            topic:  "shopping-cart-json"
        };
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_receiving_cloudevents"><a class="anchor" href="#_receiving_cloudevents"></a>Receiving CloudEvents</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Akka Serverless uses the <a href="https://cloudevents.io/">CloudEvents</a> standard when receiving from and publishing to topics. The CloudEvents specification standardizes message metadata so that systems can integrate more easily.</p>
</div>
<div class="paragraph">
<p>Describing the structure of the message payload is the CloudEvents feature most important to Akka Serverless.</p>
</div>
<div class="paragraph">
<p>An example of that is the capability to send serialized Protobuf messages and have Akka Serverless deserialize them accordingly.</p>
</div>
<div class="paragraph">
<p>To allow proper reading of Protobuf messages from topics, the messages need to specify the message attributes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Content-Type</code> = <code>application/protobuf</code></p>
</li>
<li>
<p><code>ce-specversion</code> = <code>1.0</code></p>
</li>
<li>
<p><code>ce-type</code> = fully qualified protobuf message name (eg. <code>shopping.cart.api.TopicOperation</code>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>(The <code>ce-</code> prefixed attributes are part of the CloudEvents specification.)</p>
</div>
<div class="paragraph">
<p>The Protobuf rpc declaration uses the expected Protobuf message type and specifies the topic to subscribe to. You&#8217;ll normally want to share the exact Protobuf message declaration with the sending system.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-protobuf hljs" data-lang="protobuf">syntax = "proto3";

import "google/protobuf/empty.proto";
import "google/protobuf/any.proto";
import "akkaserverless/annotations.proto";

package shopping.cart.api;

message TopicOperation {
    string operation = 1;
}

service ShoppingCartTopicService {

    rpc ProtobufFromTopic(TopicOperation) returns (google.protobuf.Empty) {
        option (akkaserverless.method).eventing.in = {
            topic:  "shopping-cart-protobuf-cloudevents"
        };
    }
}</code></pre>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="entity-eventing.html">Subscribing to a Journal</a></span>
  <span class="next"><a href="views.html">Creating Views</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">

</footer><script>window.uiRootPath = '../_'</script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
<script src="../_/js/dist/theme.1.0.3.min.js"></script>

<!--Footer Scripts Lightbend Specific-->
<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-TGBHM8D');</script>
<!-- End Google Tag Manager -->

<!-- Aha Feedback Widget -->
<script type="text/plain" class="optanon-category-3" async="async">
	function createUUID() {
		return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
			var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
			return v.toString(16);
		});
	}

	u = createUUID();

	(function (w, d, s, o, f, js, fjs) {
		w['aha-widget'] = o; w[o] = w[o] || function () { (w[o].q = w[o].q || []).push(arguments); };
		js = d.createElement(s); fjs = d.getElementsByTagName(s)[0]; js.id = o; js.src = f; js.async = 1; fjs.parentNode.insertBefore(js, fjs);
	})(window, document, 'script', 'aha', 'https://cdn.aha.io:443/assets/feedback/feedback.js');

	aha('initialize', {
		account: 'lightbend',
		applicationId: '7000060812484679534',
		user: {
			id: u,
			name: 'as-user-'+u,
			email: 'as-user-'+u+'+docs@lightbend.com',
		},
	});
</script>

<!-- Go to www.addthis.com/dashboard to customize your tools -->
<script type="text/plain" class="optanon-category-4" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5528d33a542dd356" async="async">  </body>
</html>