<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Implementing Views :: Akka Serverless Python SDK Documentation</title>
    <link rel="prev" href="topic-eventing.html">
    <link rel="next" href="serialization.html">
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../_/css/theme.1.1.0.min.css">

	<meta property="og:site_name" content="Lightbend Documentation" />
	<meta name="author" content="Lightbend Documentation">
	<link rel="shortcut icon" type="image/x-icon" href="../_/img/favicons/favicon.ico" />
	<meta itemprop="image" content="https://downloads.lightbend.com/website/social/lightbend-logo-orange-twitter.jpg">
	<meta name="twitter:image:src" content="https://downloads.lightbend.com/website/social/lightbend-logo-orange-twitter.jpg">
	<meta property="og:image" content="https://downloads.lightbend.com/website/social/lightbend-logo-orange-twitter.jpg" />
	<meta property="og:image:secure_url" content="https://downloads.lightbend.com/website/social/lightbend-logo-orange-twitter.jpg" />	<script src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js"  type="text/javascript" charset="UTF-8" data-domain-script="2f79688f-bddc-4793-a394-7539cef20516" ></script>  </head>
  <body class="article production hide-versions ">
<header class="header" role="banner">
  <nav class="navbar">
      <div class="navbar-brand">
        <a class="navbar-item" href="https://console.akkaserverless.com" target="_blank">
          <img class="header-logo lightbend-logo" src="../_/img/lightbend-reverse.svg">
        </a>
      </div>
      <div id="topbar-nav" class="navbar-menu">
        <div class="navbar-end">
            <div class="navbar-item has-dropdown is-hoverable">
            <span class="navbar-link">Console</span>
            <div class="navbar-dropdown">
              <section>
                <a data-category="Link - Drop Down Link - Lightbend Docs" href="https://console.akkaserverless.com/p/login/" target="_blank">Register or Log in</a>
                <a data-category="Link - Drop Down Link - Lightbend Docs" href="https://status.akkaserverless.com/" target="_blank">Akka Serverless Status</a>
              </section>
            </div>
          </div>
          <div class="navbar-item has-dropdown is-hoverable">
            <span class="navbar-link">Resources</span>
            <div class="navbar-dropdown">
              <section>
                  <a data-category="Link - Drop Down Link - Lightbend Docs" href="https://discuss.lightbend.com/c/akka-serverless/40" target="
                  ">Discussion Forum</a>
                  <a data-category="Link - Drop Down Link - Lightbend Docs" href="https://www.lightbend.com/blog" target="_blank">Lightbend Blog</a>
                  <a data-category="Link - Drop Down Link - Lightbend Docs" href="https://academy.lightbend.com/" target="_blank">Lightbend Academy</a>
                  <a data-category="Link - Drop Down Link - Lightbend Docs" href="https://academy.lightbend.com/courses?search_query=FILTER_TYPE_FREE" target="_blank">Free Training</a>
              </section>
            </div>
          </div>
          <div class="navbar-item has-dropdown is-hoverable">
            <span class="navbar-link">Lightbend</span>
            <div class="navbar-dropdown">
              <section>
                  <a data-category="Link - Drop Down Link - Lightbend Docs" href="https://www.lightbend.com/about-lightbend" target="_blank">Who Is Lightbend?</a>
                  <a data-category="Link - Drop Down Link - Lightbend Docs" href="https://www.lightbend.com/customers" target="_blank">Who Uses Lightbend?</a>
                  <a data-category="Link - Drop Down Link - Lightbend Docs" href="https://www.lightbend.com/certified-reactive-architect" target="_blank">Certification</a>
                  <a data-category="Link - Drop Down Link - Lightbend Docs" href="https://www.lightbend.com/company/news" target="_blank">News & Press</a>
                  <a data-category="Link - Drop Down Link - Lightbend Docs" href="https://www.lightbend.com/contact" target="_blank">Get In Contact</a>
              </section>
            </div>
          </div>
        </div>
      </div>

  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-brand">
	<img class="akka-logo akka-logo-serverless" src="../_/img/akka-serverless-full-color.svg">
</div>
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">Developing with Python</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../developing/development-process-js.html">Process overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="kickstart.html">Kickstart a Python module</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="proto.html">Writing gRPC descriptors</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="eventsourced.html">Implementing Event Sourced Entities</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="value-entity.html">Implementing Value Entities</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="actions.html">Implementing Actions</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="forwarding.html">Forwarding and effects</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="entity-eventing.html">Subscribing to a Journal</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="topic-eventing.html">Publishing and Subscribing</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="views.html">Creating Views</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="serialization.html">Handling Serialization</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="run-locally.html">Run a service locally</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title"></span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html"></a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Developing with Python</a></li>
    <li><a href="views.html">Creating Views</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/jpollock/akkaserverless-python-sdk/edit/main/docs/src/modules/python/pages/views.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="On This Page" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article id="page-content" class="doc">
<h1 class="page">Implementing Views</h1>
<fieldset class="supergroup-switch">
	




	


</fieldset><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>You can access a single <a href="https://developer.lightbend.com/docs/akka-serverless/reference/glossary.html#entity">Entity</a> with its <a href="https://developer.lightbend.com/docs/akka-serverless/reference/glossary.html#entity_key">Entity key</a>. You might want to retrieve multiple Entities, or retrieve them using an attribute other than the key. Akka Serverless <a href="https://developer.lightbend.com/docs/akka-serverless/reference/glossary.html#view">Views</a> allow you achieve this. By creating multiple Views, you can optimize for query performance against each one.</p>
</div>
<div class="paragraph">
<p>Views can be defined from any of the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#value-entity">Value Entity state changes</a></p>
</li>
<li>
<p><a href="#event-sourced-entity">Event Sourced Entity events</a></p>
</li>
<li>
<p><a href="#topic-view">Messages received from subscribing to topics on a broker</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In addition, this page describes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#_how_to_transform_results">How to transform results</a></p>
</li>
<li>
<p><a href="#testing">How to test a View</a></p>
</li>
<li>
<p><a href="#changing">How to modify a View</a></p>
</li>
<li>
<p><a href="#query">Query reference</a></p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Be aware that Views are not updated immediately when Entity state changes. Akka Serverless does update Views as quickly as possible, but it is not instant and can take up to a few seconds for the changes to become visible in the query results. View updates might also take more time during failure scenarios than during normal operation.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="https://github.com/lightbend/akkaserverless-python-sdk/tree/main/samples/js-customer-registry">The <code>akkaserverless-python-sdk</code> GitHub repository</a> includes an example of all views described on this page.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="value-entity"><a class="anchor" href="#value-entity"></a>View from a Value Entity</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Consider an example of a Customer Registry service with a <code>customer</code> Value Entity. When <code>customer</code> state changes, the entire state is emitted as a value change. Value changes update any associated Views. To create a View that lists customers by their name:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#_define_the_view_service_descriptor">Define the View service descriptor</a> for a service that selects customers by name and associates a table name with the View. The table is created and used by Akka Serverless to store the View, use any name for the table.</p>
</li>
<li>
<p><a href="#register-view">Register the View</a>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This example assumes the following <code>customer</code> state is defined in a <code>customer_domain.proto</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-proto hljs" data-lang="proto">syntax = "proto3";

package customer.domain;

message CustomerState {
  string customer_id = 1;
  string email = 2;
  string name = 3;
  Address address = 4;
}

message Address {
  string street = 1;
  string city = 2;
}</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_define_the_view_service_descriptor"><a class="anchor" href="#_define_the_view_service_descriptor"></a>Define the View service descriptor</h3>
<div class="paragraph">
<p>To get a view of multiple customers by their name, define the View as a <code>service</code> in Protobuf. The descriptor defines:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>How to update the View</p>
</li>
<li>
<p>The source of View data</p>
</li>
<li>
<p>A <code>table</code> attribute that can be any name. Use this name in the query <code>SELECT</code> statement for the View.</p>
</li>
<li>
<p>The query that returns customers by name</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-proto hljs" data-lang="proto">syntax = "proto3";

package customer.view;

import "customer_domain.proto";
import "akkaserverless/annotations.proto";
import "google/protobuf/any.proto";

service CustomerByName {
  rpc UpdateCustomer(domain.CustomerState) returns (domain.CustomerState) { <i class="conum" data-value="1"></i><b>(1)</b>
    option (akkaserverless.method).eventing.in = { <i class="conum" data-value="2"></i><b>(2)</b>
      value_entity: "customers"
    };
    option (akkaserverless.method).view.update = { <i class="conum" data-value="3"></i><b>(3)</b>
      table: "customers"
    };
  }

  rpc GetCustomers(ByNameRequest) returns (stream domain.CustomerState) { <i class="conum" data-value="4"></i><b>(4)</b>
    option (akkaserverless.method).view.query = { <i class="conum" data-value="5"></i><b>(5)</b>
      query: "SELECT * FROM customers WHERE name = :customer_name"
    };
  }
}

message ByNameRequest {
  string customer_name = 1;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>UpdateCustomer</code> method defines how Akka Serverless will update the view.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The source of the View is the <code>"customers"</code> Value Entity. This identifier is defined in the <code>@ValueEntity(entityType = "customers")</code> annotation of the Value Entity.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>(akkaserverless.method).view.update</code> annotation defines that this method is used for updating the View. You must define the <code>table</code> attribute for the table to be used in the query. Pick any name and use it in the query <code>SELECT</code> statement.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The <code>GetCustomers</code> method defines the query to retrieve a stream of customers.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The <code>(akkaserverless.method).view.query</code> annotation defines that this method is used as a query of the View.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the query should return only one result, <code>stream</code> can be removed from the return type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-proto hljs" data-lang="proto">rpc GetCustomer(ByEmailRequest) returns (domain.CustomerState) { <i class="conum" data-value="1"></i><b>(1)</b>
  option (akkaserverless.method).view.query = {
    query: "SELECT * FROM customers WHERE email = :email"
  };
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Without <code>stream</code> when expecting single result.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When no result is found, the request fails with gRPC status code <code>NOT_FOUND</code>. A streamed call completes with an empty stream when no result is found.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>See <a href="#query">Query syntax reference</a> for examples of valid query syntax.</p>
</div>
</div>
<div class="sect2">
<h3 id="register-view"><a class="anchor" href="#register-view"></a>Register the View</h3>
<div class="paragraph">
<p>In the View implementation, register the View with Akka Serverless. In addition to passing the service descriptor and a unique identifier, pass any descriptors that define state. In this example, the <code>customer_domain.proto</code> descriptor defines the Value Entity state:</p>
</div>
<div class="listingblock">
<div class="title">customer_value_entity_view.py</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js hljs" data-lang="js"></code></pre>
</div>
</div>
<div class="paragraph">
<p>Invoke the <code>addComponent</code> function to register the view with the service. For example:</p>
</div>
<div class="listingblock">
<div class="title">index.py</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js hljs" data-lang="js"></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="event-sourced-entity"><a class="anchor" href="#event-sourced-entity"></a>View from Event Sourced Entity</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Construct Event Sourced Entity Views from the events that the Entity emits. Build a state representation from the events and Query them. Using a Customer Registry service example, to create a View for querying customers by name:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#_define_the_view_descriptor">Define the View descriptor</a>.</p>
</li>
<li>
<p><a href="#_implement_transformation_functions">Implement transformation functions</a>.</p>
</li>
<li>
<p><a href="#ES_register">Register the View</a>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The example assumes a <code>customer_domain.proto</code> file that defines the events that
will update the View when a name changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-proto hljs" data-lang="proto">syntax = "proto3";

package customer.domain;

message CustomerCreated {
  CustomerState customer = 1;
}

message CustomerNameChanged {
  string new_name = 1;
}

message CustomerAddressChanged {
  Address new_address = 1;
}</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_define_the_view_descriptor"><a class="anchor" href="#_define_the_view_descriptor"></a>Define the View descriptor</h3>
<div class="paragraph">
<p>A view descriptor:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Defines update methods for events.</p>
</li>
<li>
<p>Provides the source of the View.</p>
</li>
<li>
<p>Enables transformation updates.</p>
</li>
<li>
<p>Specifies a <code>table</code> attribute used by Akka Serverless to store the View. Pick any name and use it in the Query <code>SELECT</code> statement for the View.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following example <code>customer_view.proto</code> file defines a View to consume the <code>CustomerCreated</code> and <code>CustomerNameChanged</code> events. It must ignore all other events.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-proto hljs" data-lang="proto">syntax = "proto3";

package customer.view;

import "customer_domain.proto";
import "akkaserverless/annotations.proto";
import "google/protobuf/any.proto";

service CustomerByNameView {
  rpc ProcessCustomerCreated(domain.CustomerCreated) returns (domain.CustomerState) { <i class="conum" data-value="1"></i><b>(1)</b>
    option (akkaserverless.method).eventing.in = {
      event_sourced_entity: "customers" <i class="conum" data-value="2"></i><b>(2)</b>
    };
    option (akkaserverless.method).view.update = {
      table: "customers"
      transform_updates: true <i class="conum" data-value="3"></i><b>(3)</b>
    };
  }

  rpc ProcessCustomerNameChanged(domain.CustomerNameChanged) returns (domain.CustomerState) { <i class="conum" data-value="4"></i><b>(4)</b>
    option (akkaserverless.method).eventing.in = {
      event_sourced_entity: "customers" <i class="conum" data-value="5"></i><b>(5)</b>
    };
    option (akkaserverless.method).view.update = {
      table: "customers"
      transform_updates: true <i class="conum" data-value="6"></i><b>(6)</b>
    };
  }

  rpc IgnoreOtherEvents(google.protobuf.Any) returns (domain.CustomerState) { <i class="conum" data-value="7"></i><b>(7)</b>
    option (akkaserverless.method).eventing.in = {
      event_sourced_entity: "customers"
     };
     option (akkaserverless.method).view.update = {
       table: "customers"
       transform_updates: true
     };
  };

  rpc GetCustomers(ByNameRequest) returns (stream domain.CustomerState) {
    option (akkaserverless.method).view.query = {
      query: "SELECT * FROM customers WHERE name = :customer_name"
    };
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Define an update method for each event.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The source of the View is from the journal of the <code>"customers"</code> Event Sourced Entity. This identifier is defined in the <code>@EventSourcedEntity(entityType = "customers")</code> annotation of the Event Sourced Entity.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Enable <code>transform_updates</code> to be able to build the View state from the events.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>One method for each event.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The same <code>event_sourced_entity</code> for all update methods. Note the required <code>table</code> attribute. Use any name, which you will reference in the query <code>SELECT</code> statement.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Enable <code>transform_updates</code> for all update methods.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Ignore events not relevant to this view.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>See <a href="#query">Query syntax reference</a> for more examples of valid query syntax.</p>
</div>
</div>
<div class="sect2">
<h3 id="_implement_transformation_functions"><a class="anchor" href="#_implement_transformation_functions"></a>Implement transformation functions</h3>
<div class="paragraph">
<p>Implement the View by defining the functions that transform events to View state and ignore other events:</p>
</div>
<div class="listingblock">
<div class="title">customer_eventsourced_view.py</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js hljs" data-lang="js">Unresolved include directive in modules/python/pages/views.adoc - include::example$python-customer-registry/customer_eventsourced_view.py[]</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Each update method in the Protobuf definition should have a corresponding Python function in <code>view.setUpdateHandlers</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The first function parameter should correspond to the parameter in the Protobuf service call, that is, the event. You can optionally define a second parameter for the previous state. For the first event of an Event Sourced Entity or for the first change of a Value Entity there is no previous state and <code>null</code> is used for the state parameter. The function may also take a <code>UpdateHandlerContext</code> parameter.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This type of update transformation is a natural fit for Events emitted by an Event Sourced Entity, but it can also be used for Value Entities. For example, if the View representation is different from the Entity state you might want to transform it before presenting the View to the client.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="ES_register"><a class="anchor" href="#ES_register"></a>Register the View</h3>
<div class="paragraph">
<p>In the implementation, register the View with <code>AkkaServerless</code>:</p>
</div>
<div class="listingblock">
<div class="title">customer_eventsourced_view.py</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js hljs" data-lang="js">Unresolved include directive in modules/python/pages/views.adoc - include::example$python-customer-registry/customer_eventsourced_view.py[]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Invoke the <code>addComponent</code> function to register the view with the service. For example:</p>
</div>
<div class="listingblock">
<div class="title">index.py</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js hljs" data-lang="js"></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="topic-view"><a class="anchor" href="#topic-view"></a>View from a topic</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The source of a View can be an eventing topic. You define it in the same way as described in <a href="#event-sourced-entity">View from Event Sourced Entity</a> or <a href="#value-entity">View from a Value Entity</a>, but leave out the <code>eventing.in</code> annotation in the Protobuf.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-proto hljs" data-lang="proto">syntax = "proto3";

package customer.view;

import "customer_domain.proto";
import "akkaserverless/annotations.proto";
import "google/protobuf/any.proto";

service CustomerByNameViewFromTopic {
  rpc ProcessCustomerCreated(domain.CustomerCreated) returns (domain.CustomerState) {
    option (akkaserverless.method).eventing.in = {
      topic: "customers" <i class="conum" data-value="1"></i><b>(1)</b>
    };
    option (akkaserverless.method).view.update = {
      table: "customers"
      transform_updates: true
    };
  }

  rpc ProcessCustomerNameChanged(domain.CustomerNameChanged) returns (domain.CustomerState) {
    option (akkaserverless.method).eventing.in = {
      topic: "customers"
    };
    option (akkaserverless.method).view.update = {
      table: "customers"
      transform_updates: true
    };
  }

  rpc IgnoreOtherEvents(google.protobuf.Any) returns (domain.CustomerState) {
    option (akkaserverless.method).eventing.in = {
      event_sourced_entity: "customers"
     };
     option (akkaserverless.method).view.update = {
       table: "customers"
       transform_updates: true
     };
  };

  rpc GetCustomers(ByNameRequest) returns (stream domain.CustomerState) {
    option (akkaserverless.method).view.query = {
      query: "SELECT * FROM customers WHERE name = :customer_name"
    };
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is the only difference from <a href="#event-sourced-entity">View from Event Sourced Entity</a>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_to_transform_results"><a class="anchor" href="#_how_to_transform_results"></a>How to transform results</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To obtain different results than shown in the examples above, you can transform them:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>As a <a href="#_relational_projection">Relational projection</a></p>
</li>
<li>
<p>As a <a href="#_response_message_including_the_result">Response message including the result</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_relational_projection"><a class="anchor" href="#_relational_projection"></a>Relational projection</h3>
<div class="paragraph">
<p>Instead of using <code>SELECT *</code> you can define the columns to use in the response message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-proto hljs" data-lang="proto">syntax = "proto3";

package customer.view;

import "customer_domain.proto";
import "akkaserverless/annotations.proto";
import "google/protobuf/any.proto";

message CustomerSummary {
  string id = 1;
  string name = 2;
}

service CustomerSummaryByName {
  rpc GetCustomers(ByNameRequest) returns (stream CustomerSummary) {
    option (akkaserverless.method).view.query = {
      query: "SELECT customer_id AS id, name FROM customers WHERE name = :customer_name"
    };
  }

  rpc UpdateCustomer(domain.CustomerState) returns (domain.CustomerState) {
    option (akkaserverless.method).eventing.in = {
      value_entity: "customers"
    };
    option (akkaserverless.method).view.update = {
      table: "customers"
    };
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Similarly, you can include values from the request message in the response, such as <code>:request_id</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-proto hljs" data-lang="proto">SELECT :request_id, customer_id as id, name FROM customers WHERE name = :customer_name</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_response_message_including_the_result"><a class="anchor" href="#_response_message_including_the_result"></a>Response message including the result</h3>
<div class="paragraph">
<p>Instead of streamed results, you can include the results in a repeated field in the response message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-proto hljs" data-lang="proto">message CustomersResponse {
  repeated domain.CustomerState results = 1; <i class="conum" data-value="1"></i><b>(1)</b>
}

service CustomersResponseByName {
  rpc GetCustomers(ByNameRequest) returns (CustomersResponse) { <i class="conum" data-value="2"></i><b>(2)</b>
    option (akkaserverless.method).view.query = {
      query: "SELECT * AS results FROM customers WHERE name = :customer_name" <i class="conum" data-value="3"></i><b>(3)</b>
    };
  }

  rpc UpdateCustomer(domain.CustomerState) returns (domain.CustomerState) {
    option (akkaserverless.method).eventing.in = {
      value_entity: "customers"
    };
    option (akkaserverless.method).view.update = {
      table: "customers"
    };
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The response message contains a <code>repeated</code> field.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The return type is not <code>streamed</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>repeated</code> field is referenced in the query with <code>* AS results</code>.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="testing"><a class="anchor" href="#testing"></a>How to test a View</h2>
<div class="sectionbody">
<div class="paragraph">
<p>TO-DO</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="changing"><a class="anchor" href="#changing"></a>How to modify a View</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Akka Serverless creates indexes for the View based on the query. For example, the following query will result in a View with an index on the <code>name</code> column:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-proto hljs" data-lang="proto">SELECT * FROM customers WHERE name = :customer_name</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the query is changed, Akka Serverless might need to add other indexes. For example, changing the above query to filter on the <code>city</code> would mean that Akka Serverless needs to build a View with the index on the <code>city</code> column.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-proto hljs" data-lang="proto">SELECT * FROM customers WHERE address.city = :city</code></pre>
</div>
</div>
<div class="paragraph">
<p>Such changes require you to define a new View. Akka Serverless will then rebuild it from the source event log or value changes.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Views from topics cannot be rebuilt from the source messages, because it&#8217;s not possible to consume all events from the topic again. The new View will be built from new messages published to the topic.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Rebuilding a new View may take some time if there are many events that have to be processed. The recommended way when changing a View is multi-step, with two deployments:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Define the new View, and keep the old View intact. A new View is defined by a new <code>service</code> in Protobuf and different <code>viewId</code> when <a href="#register-view">Register the View</a>. Keep the old <code>registerView</code>.</p>
</li>
<li>
<p>Deploy the new View, and let it rebuild. Verify that the new query works as expected. The old View can still be used.</p>
</li>
<li>
<p>Remove the old View definition and rename the <code>service</code> to the old name if the public API is compatible.</p>
</li>
<li>
<p>Deploy the second change.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The View definitions are stored and validated when a new version is deployed. There will be an error message if the changes are not compatible.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="query"><a class="anchor" href="#query"></a>Query syntax reference</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Define View queries in a language that is similar to SQL. The following examples illustrate the syntax for a <code>customers</code> entity, where the <code>.proto</code> file defines the <code>table</code> attribute as <code>customers</code>. To retrieve:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>All customers without any filtering conditions (no WHERE clause):</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-proto hljs" data-lang="proto">SELECT * FROM customers</code></pre>
</div>
</div>
</li>
<li>
<p>Customers with a name matching the <code>customer_name</code> property of the request:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-proto hljs" data-lang="proto">SELECT * FROM customers WHERE name = :customer_name</code></pre>
</div>
</div>
</li>
<li>
<p>Customers with matching <code>customer_name</code> AND <code>city</code> properties of the request:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-proto hljs" data-lang="proto">SELECT * FROM customers WHERE name = :customer_name AND address.city = :city</code></pre>
</div>
</div>
</li>
<li>
<p>Customers in a city matching a literal value:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-proto hljs" data-lang="proto">SELECT * FROM customers WHERE address.city = 'New York'</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_query_filter_predicates"><a class="anchor" href="#_query_filter_predicates"></a>Query filter predicates</h3>
<div class="paragraph">
<p>Filter predicates include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>=</code> equals</p>
</li>
<li>
<p><code>!=</code> not equals</p>
</li>
<li>
<p><code>&gt;</code> greater than</p>
</li>
<li>
<p><code>&gt;=</code> greater than or equals</p>
</li>
<li>
<p><code>&lt;</code> less than</p>
</li>
<li>
<p><code>&lt;=</code> less than or equals</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The filter conditions can be combined with <code>AND</code>/<code>OR</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-proto hljs" data-lang="proto">SELECT * FROM customers WHERE
  name = :customer_name AND address.city = 'New York' OR
  name = :customer_name AND address.city = 'San Francisco'</code></pre>
</div>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="topic-eventing.html">Publishing and Subscribing</a></span>
  <span class="next"><a href="serialization.html">Handling Serialization</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
	<nav>
	<section>
		<h3>Lightbend Docs</h3>
		<ul>
			<li><a data-category="Link - Footer - Lightbend Docs" href="https://developer.lightbend.com/docs/akka-platform-guide/">Akka Platform Guide</a></li>
            <li><a data-category="Link - Footer - Lightbend Docs" href="https://developer.lightbend.com/docs/cloudflow/current/index.html">Akka Data Pipelines</a></li>
            <li><a data-category="Link - Footer - Lightbend Docs" href="https://developer.lightbend.com/docs/akka-serverless/">Akka Serverless</a></li>
			<li><a data-category="Link - Footer - Lightbend Docs" href="https://developer.lightbend.com/docs/fortify/current/">Fortify SCA for Scala</a></li>	
			<li><a data-category="Link - Footer - Lightbend Docs" href="https://developer.lightbend.com/docs/console/current/">Lightbend Console</a></li>
			<li><a data-category="Link - Footer - Lightbend Docs" href="https://developer.lightbend.com/docs/telemetry/current/home.html">Lightbend Telemetry</a></li>
		</ul>
	</section>
	<section>
		<h3>Open Source Docs</h3>
		<ul>
			<li><a data-category="Link - Footer - Lightbend Docs" href="https://akka.io/docs/">Akka</a></li>
    		<li><a data-category="Link - Footer - Lightbend Docs" href="https://doc.akka.io/docs/alpakka/current/">Alpakka</a></li>
			<li><a data-category="Link - Footer - Lightbend Docs" href="https://cloudflow.io/docs/current/">Cloudflow</a></li>	
			<li><a data-category="Link - Footer - Lightbend Docs" href="https://cloudstate.io/docs/">Cloudstate</a></li>	
			<li><a data-category="Link - Footer - Lightbend Docs" href="https://www.scala-sbt.org/1.x/docs/">sbt</a></li>
			<li><a data-category="Link - Footer - Lightbend Docs" href="https://docs.scala-lang.org/">Scala</a></li>
		</ul>
	</section>
	<section>
		<h3>Resources</h3>
		<ul>
			<li><a data-category="Link - Footer - Lightbend Docs" href="https://portal.lightbend.com/">Customer Portal</a></li>
			<li><a data-category="Link - Footer - Lightbend Docs" href="https://discuss.lightbend.com">Discussion Forums</a></li>
			<li><a data-category="Link - Footer - Lightbend Docs" href="https://www.lightbend.com/blog">Lightbend Blog</a></li>
			<li><a data-category="Link - Footer - Lightbend Docs" href="https://academy.lightbend.com/">Lightbend Academy</a></li>
            <li><a data-category="Link - Footer - Lightbend Docs" href="https://academy.lightbend.com/courses?search_query=FILTER_TYPE_FREE">Free Training</a></li>
			<li><a data-category="Link - Footer - Lightbend Docs" href="https://www.lightbend.com/resources">Latest Resources</a></li>
		</ul>
	</section>
	<section>
		<h3>Lightbend</h3>
		<ul>
			<li><a data-category="Link - Footer - Lightbend Docs" href="https://www.lightbend.com/about-lightbend">Who Is Lightbend?</a></li>
			<li><a data-category="Link - Footer - Lightbend Docs" href="https://www.lightbend.com/customers">Who Uses Lightbend?</a></li>
			<li><a data-category="Link - Footer - Lightbend Docs" href="https://www.lightbend.com/lightbend-subscription">Why Get A Subscription?</a></li>
			<li><a data-category="Link - Footer - Lightbend Docs" href="https://www.lightbend.com/certified-reactive-architect">Certification</a></li>
			<li><a data-category="Link - Footer - Lightbend Docs" href="https://www.lightbend.com/company/news">News & Press</a></li>
			<li><a data-category="Link - Footer - Lightbend Docs" href="https://www.lightbend.com/contact">Get In Contact</a></li>
		</ul>
	</section>
</nav>
	<div class="docs-social-footer">
	<!-- Go to www.addthis.com/dashboard to customize your tools --> 
	<div class="addthis_inline_follow_toolbox_5vul"></div>
</div>
<div class="docs-legal-footer">
	<div class="inner-wrapper">

		<div class="links">
			<p>Â© Lightbend 2021 | <a href="https://www.lightbend.com/legal/licenses">Licenses</a> | <a href="https://www.lightbend.com/legal/terms">Terms</a> | <a href="https://www.lightbend.com/legal/privacy">Privacy Policy</a> | <a href="https://www.lightbend.com/legal/cookie">Cookie Listing</a> | <a class="optanon-toggle-display">Cookie Settings</a> | <a rel="alternate" type="application/rss+xml" href="https://www.lightbend.com/blog/rss.xml" target="_blank">RSS</a></p>
		</div>

		<div class="brand">
			<a href="https://www.lightbend.com" class="footer-logo">
				<svg class="lightbend-logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 372 80">
					<title>lightbend-logo</title>
					<g id="lightbend-logo">
						<path d="M1,59V76a3,3,0,0,0,3,3H88a3,3,0,0,0,3-3V59a167.38,167.38,0,0,1-45,6A167.38,167.38,0,0,1,1,59Z" fill="#ffffff"></path>
						<path d="M88,1H4A3,3,0,0,0,1,4V53c14.57,4.2,29.65,7,45,7s30.43-2.8,45-7V4A3,3,0,0,0,88,1Z" fill="#ffffff"></path>
						<g id="original_weight" data-name="original weight">
							<path d="M107.2,20.08a2.14,2.14,0,1,1,4.27,0v32h13.6A2,2,0,0,1,127,54a1.94,1.94,0,0,1-1.94,2H109.31a2.15,2.15,0,0,1-2.11-2.16Z" fill="#ffffff"></path>
							<path d="M135,19.32a2.47,2.47,0,0,1,4.91,0V20A2.47,2.47,0,0,1,135,20Zm.38,10.59a2.08,2.08,0,1,1,4.16,0V54.15a2,2,0,0,1-2.06,2.11,2.08,2.08,0,0,1-2.1-2.11Z" fill="#ffffff"></path>
							<path d="M150.8,61.44a1.91,1.91,0,0,1-1.08-1.73,2,2,0,0,1,1.89-1.83,1.69,1.69,0,0,1,.92.27,17.63,17.63,0,0,0,9.88,3c6.15,0,10.15-3.4,10.15-9.93v-3.3c-2.43,3.24-5.83,5.89-11,5.89a12.9,12.9,0,0,1-13.12-13.07v-.11a13.21,13.21,0,0,1,24-7.56V29.91a2.07,2.07,0,0,1,2.06-2.11,2.11,2.11,0,0,1,2.1,2.11V51.13c0,4.32-1.29,7.61-3.56,9.88-2.49,2.48-6.21,3.73-10.64,3.73A21.87,21.87,0,0,1,150.8,61.44Zm21.87-20.73V40.6c0-5.72-5-9.45-10.26-9.45s-9.67,3.67-9.67,9.4v.1a9.45,9.45,0,0,0,9.67,9.51C167.7,50.16,172.67,46.32,172.67,40.71Z" fill="#ffffff"></path>
							<path d="M186.22,18.41a2.08,2.08,0,1,1,4.16,0V32.93a10.57,10.57,0,0,1,9.56-5.45c6.75,0,10.69,4.53,10.69,11.18V54.15a2.08,2.08,0,1,1-4.16,0V39.68c0-5.18-2.81-8.42-7.72-8.42s-8.37,3.51-8.37,8.75V54.15a2,2,0,0,1-2,2.11,2.08,2.08,0,0,1-2.11-2.11Z" fill="#ffffff"></path>
							<path d="M220.46,48.59V31.74h-2.27a1.89,1.89,0,0,1-1.84-1.83,1.86,1.86,0,0,1,1.84-1.84h2.27V21.48a2.06,2.06,0,0,1,2-2.1,2.14,2.14,0,0,1,2.1,2.1v6.59h7.24a1.91,1.91,0,0,1,1.89,1.84,1.86,1.86,0,0,1-1.89,1.83h-7.24V48.05c0,3.4,1.89,4.64,4.7,4.64a12,12,0,0,0,2.54-.37,1.8,1.8,0,0,1,1.78,1.78,1.73,1.73,0,0,1-1.19,1.62,10.57,10.57,0,0,1-4.1.75C223.86,56.47,220.46,54.26,220.46,48.59Z" fill="#ffffff"></path>
							<path d="M242.65,18.41a2.08,2.08,0,1,1,4.16,0V33.69c2.27-3.35,5.56-6.21,10.69-6.21,6.7,0,13.34,5.29,13.34,14.47v.11c0,9.12-6.59,14.52-13.34,14.52a12.6,12.6,0,0,1-10.69-5.94v3.51a2.07,2.07,0,0,1-2.05,2.11,2.11,2.11,0,0,1-2.11-2.11Zm23.92,23.7V42c0-6.58-4.53-10.8-9.83-10.8A10.41,10.41,0,0,0,246.65,42v.11c0,6.48,4.91,10.8,10.09,10.8C262.14,52.86,266.57,48.86,266.57,42.11Z" fill="#ffffff"></path>
							<path d="M290.17,56.64c-7.67,0-13.93-5.89-13.93-14.53V42c0-8,5.67-14.52,13.39-14.52,8.26,0,13,6.75,13,14.15a1.94,1.94,0,0,1-1.95,1.94H280.45c.59,6,4.86,9.45,9.83,9.45a11.4,11.4,0,0,0,8-3.24,1.83,1.83,0,0,1,1.19-.49,1.81,1.81,0,0,1,1.84,1.78,1.78,1.78,0,0,1-.65,1.35A14.2,14.2,0,0,1,290.17,56.64Zm8.26-16.15c-.43-5.07-3.35-9.5-8.91-9.5-4.86,0-8.53,4.05-9.07,9.5Z" fill="#ffffff"></path>
							<path d="M309.5,29.91a2.08,2.08,0,1,1,4.16,0v3a10.57,10.57,0,0,1,9.56-5.45c6.75,0,10.69,4.53,10.69,11.18V54.15a2.08,2.08,0,1,1-4.16,0V39.68c0-5.18-2.81-8.42-7.72-8.42s-8.37,3.51-8.37,8.75V54.15a2,2,0,0,1-2.05,2.11,2.08,2.08,0,0,1-2.11-2.11Z" fill="#ffffff"></path>
							<path d="M368.68,54.15a2.08,2.08,0,1,1-4.15,0V50.37c-2.27,3.35-5.57,6.21-10.7,6.21-6.69,0-13.33-5.29-13.33-14.47V42c0-9.12,6.64-14.52,13.33-14.52a12.61,12.61,0,0,1,10.7,5.94v-15a2,2,0,0,1,2.05-2.11,2.07,2.07,0,0,1,2.1,2.11ZM344.76,42v.11c0,6.58,4.59,10.8,9.83,10.8a10.43,10.43,0,0,0,10.1-10.8V42a10.38,10.38,0,0,0-10.1-10.75C349.19,31.2,344.76,35.2,344.76,42Z" fill="#ffffff"></path>
						</g>
					</g>
				</svg>
			</a>
		</div>

	</div>
</div></footer><script>window.uiRootPath = '../_'</script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
<script src="../_/js/dist/theme.1.0.3.min.js"></script>

<!--Footer Scripts Lightbend Specific-->
<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-TGBHM8D');</script>
<!-- End Google Tag Manager -->

<!-- Aha Feedback Widget -->
<script type="text/plain" class="optanon-category-3" async="async">
	function createUUID() {
		return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
			var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
			return v.toString(16);
		});
	}

	u = createUUID();

	(function (w, d, s, o, f, js, fjs) {
		w['aha-widget'] = o; w[o] = w[o] || function () { (w[o].q = w[o].q || []).push(arguments); };
		js = d.createElement(s); fjs = d.getElementsByTagName(s)[0]; js.id = o; js.src = f; js.async = 1; fjs.parentNode.insertBefore(js, fjs);
	})(window, document, 'script', 'aha', 'https://cdn.aha.io:443/assets/feedback/feedback.js');

	aha('initialize', {
		account: 'lightbend',
		applicationId: '7000060812484679534',
		user: {
			id: u,
			name: 'as-user-'+u,
			email: 'as-user-'+u+'+docs@lightbend.com',
		},
	});
</script>

<!-- Go to www.addthis.com/dashboard to customize your tools -->
<script type="text/plain" class="optanon-category-4" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5528d33a542dd356" async="async">  </body>
</html>